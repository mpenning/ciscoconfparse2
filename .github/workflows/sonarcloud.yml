---
name: 'SonarCloud'
on:
  push:
    branches:
      - 'main'
  pull_request:
    types:
      - 'opened'
      - 'synchronize'
      - 'reopened'

permissions:
    # All other scopes not listed are set to 'none' by default
  contents: "read"
  issues: "read"    # Grants read permission for issues

jobs:
  sonarqube:
    name: 'SonarQube'
    runs-on: 'ubuntu-latest'
    steps:
      - uses: "actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd" # v6.0.2
        with:
          fetch-depth: 0
      - name: 'Setup Python'
        uses: "actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405" # v6.2.0
        with:
          python-version: '3.12'
      - name: 'Install ciscoconfparse2'
        run: 'pip install .'
      - name: 'Install coverage'
        run: 'pip install coverage==5.0.0'
      - name: 'Install pytest'
        run: 'pip install pytest'
      - name: 'Run coverage'
        working-directory: "tests"
        run: 'coverage run -m pytest'
      - name: 'Generate xml'
        working-directory: "tests"
        run: 'coverage xml -o coverage.xml'
      - name: 'Relocate the coverage report'
        run: 'mv tests/coverage.xml coverage.xml'
      - name: 'SonarQube Scan'
        uses: 'SonarSource/sonarqube-scan-action@master'
        env:
          SONAR_TOKEN: '${{ secrets.SONAR_TOKEN }}'
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
